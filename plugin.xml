<?xml version="1.0" encoding="UTF-8"?>
<?eclipse version="3.4"?>
<plugin>
   <!-- Editor extension for .jl lexer descriptions -->
   <extension
         point="org.eclipse.ui.editors">
      <editor
            name="Dolmen Lexer Editor"
            extensions="jl"
            icon="icons/sample.gif"
            contributorClass="org.eclipse.ui.texteditor.BasicTextEditorActionContributor"
            class="dolmenplugin.editors.jl.JLEditor"
            id="dolmenplugin.editors.jl.JLEditor">
      </editor>
   </extension>

   <!-- Editor extension for .jg grammar descriptions -->
   <extension
         point="org.eclipse.ui.editors">
      <editor
            name="Dolmen Grammar Editor"
            extensions="jg"
            icon="icons/sample.gif"
            contributorClass="org.eclipse.ui.texteditor.BasicTextEditorActionContributor"
            class="dolmenplugin.editors.jg.JGEditor"
            id="dolmenplugin.editors.jg.JGEditor">
      </editor>
   </extension>

   <!-- Builder extension for .jl lexer and .jg grammar descriptions -->
   <extension point="org.eclipse.core.resources.builders"
         name="Dolmen Lexer and Grammar Builder"
         id="dolmenplugin.base.Builder">
      <builder
            hasNature="true">
         <run
          class="dolmenplugin.base.Builder">
         </run>
      </builder>
   </extension>
   
   <!-- Marker extension for Dolmen files -->
   <extension
         id="dolmenplugin.base.marker"
         name="Dolmen problems"
         point="org.eclipse.core.resources.markers">
      <super
            type="org.eclipse.core.resources.problemmarker">
      </super>
   </extension>

   <!-- Nature extension for project containing Dolmen files -->
   <extension point="org.eclipse.core.resources.natures"
         name="Dolmen Nature"
         id="DolmenNature" >
      <runtime>
         <run
          class="dolmenplugin.base.Nature">
         </run>
      </runtime>
<!--
      <requires-nature
            id="org.eclipse.jdt.core.javanature">
      </requires-nature>
-->
   </extension>
   
   <!-- Expression checking the Dolmen nature of one project -->
   <!-- NB: Even when selecting only a single projects, it seems the
   		default variable received from the Package Explorer is an array
   		of IProject, so we need to be careful and iterate on the selection.
   		Conversely, if the Navigator or Project Explorer sends the IProject
   		as is, can it be adapted to a singleton iterable? I hope so... -->
   <extension
         point="org.eclipse.core.expressions.definitions">
      <definition
            id="DolmenPlugin.hasNature">
         <adapt
               type="org.eclipse.core.resources.IResource">
            <test
                  property="org.eclipse.core.resources.projectNature"
                  value="DolmenPlugin.DolmenNature">
            </test>
         </adapt>
      </definition>
   </extension>
   
   <!-- Declaration of the commands to add and remove the Dolmen nature -->
   <extension
         point="org.eclipse.ui.commands">
      <command
            description="Use this command to add the Dolmen nature to the selected project"
            id="dolmenplugin.ConvertDolmenNatureCommand"
            name="Convert to Dolmen Project">
      </command>
      <command
            description="Use this command to remove the Dolmen nature from the selected project"
            id="dolmenplugin.RemoveDolmenNatureCommand"
            name="Remove Dolmen nature">
      </command>
   </extension>
   
   <!-- Handler for the commands to add and remove the Dolmen nature -->
   <extension
         point="org.eclipse.ui.handlers">
      <handler
            class="dolmenplugin.handlers.ConvertDolmenNatureHandler"
            commandId="dolmenplugin.ConvertDolmenNatureCommand">
      </handler>
      <handler
            class="dolmenplugin.handlers.RemoveDolmenNatureHandler"
            commandId="dolmenplugin.RemoveDolmenNatureCommand">
      </handler>
   </extension>
   
   <!-- Menu contribution to the Project -> Configure -> -->
   <extension
         point="org.eclipse.ui.menus">
      <menuContribution
            allPopups="false"
            locationURI="popup:org.eclipse.ui.projectConfigure">
         <command
               commandId="dolmenplugin.ConvertDolmenNatureCommand"
               label="Add Dolmen nature"
               style="push">
         	<!-- Only visible when ALL selected projects are missing the Dolmen nature -->
            <visibleWhen
                  checkEnabled="false">
               <iterate ifEmpty="false">
               	<not>
               	  <reference
                        definitionId="DolmenPlugin.hasNature">
               	  </reference>
               	</not>
               </iterate>
            </visibleWhen>
         </command>
      </menuContribution>
      
      <menuContribution
            allPopups="false"
            locationURI="popup:org.eclipse.ui.projectConfigure">
         <command
               commandId="dolmenplugin.RemoveDolmenNatureCommand"
               label="Remove Dolmen nature"
               style="push">
             <!-- Only visible when ALL selected projects have the Dolmen nature -->
             <visibleWhen checkEnabled="false">
               <iterate ifEmpty="false">
               	  <reference
                        definitionId="DolmenPlugin.hasNature">
               	  </reference>
               </iterate>
             </visibleWhen>
         </command>
      </menuContribution>
   </extension>
   
   <!-- Defining a decorator for project with the Dolmen nature -->
   <extension
         point="org.eclipse.ui.ide.projectNatureImages">
      <image
            icon="icons/sample.gif"
            id="DolmenPlugin.DolmenNatureImage"
            natureId="DolmenPlugin.DolmenNature">
      </image>
   </extension>
   
</plugin>
